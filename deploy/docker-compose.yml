# ============================================================
# NeuroNet — Full Stack Deployment
# ============================================================
#
# Usage:
#   cp .env.example .env   # edit with real values
#   docker network create neuro-network
#   docker compose up -d
#
# This brings up:
#   - RabbitMQ (message bus)
#   - HashiCorp Vault (secrets)
#   - Postgres (IAM + audit)
#   - Vault-IAM (identity, RBAC)
#   - Resolver (RBAC gateway)
#   - Connector-EntraID (Graph API)
#   - Connector-Slack (user-token agent)
#   - Agent-Worker-Claude (AI)

services:

  # ── Infrastructure ────────────────────────────────────────

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: neuro-rabbitmq
    restart: unless-stopped
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?Set RABBITMQ_PASSWORD}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/neuro}
    ports:
      - "5672:5672"
      - "15672:15672"   # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - neuro-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 10s
      timeout: 5s
      retries: 5

  hcvault:
    image: hashicorp/vault:1.15
    container_name: neuro-hcvault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_API_ADDR: "http://hcvault:8200"
      VAULT_LOCAL_CONFIG: |
        {
          "storage": { "file": { "path": "/vault/data" } },
          "listener": { "tcp": { "address": "0.0.0.0:8200", "tls_disable": true } },
          "ui": true,
          "disable_mlock": true
        }
    command: sh -c "chown -R vault:vault /vault/data && su-exec vault vault server -config=/vault/config"
    ports:
      - "8200:8200"     # Vault UI + API
    user: root
    volumes:
      - hcvault-data:/vault/data
      - ../services/vault/hcvault/policies:/vault/policies:ro
    networks:
      - neuro-network
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  vault-db:
    image: postgres:16-alpine
    container_name: neuro-vault-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: neuro_vault
      POSTGRES_USER: neuro
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}
      VAULT_IAM_DB_PASSWORD: ${VAULT_IAM_DB_PASSWORD:?Set VAULT_IAM_DB_PASSWORD}
    volumes:
      - vault-db-data:/var/lib/postgresql/data
      - ../services/vault/db/000_users.sh:/docker-entrypoint-initdb.d/000_users.sh:ro
      - ../services/vault/db/001_schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    networks:
      - neuro-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neuro -d neuro_vault"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Services ──────────────────────────────────────────────

  vault-iam:
    build:
      context: ../services/vault/vault-iam
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-vault-iam
    restart: unless-stopped
    depends_on:
      vault-db:
        condition: service_healthy
      hcvault:
        condition: service_healthy
    environment:
      NEURO_SERVICE_NAME: vault-iam
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      POSTGRES_HOST: vault-db
      POSTGRES_DB: neuro_vault
      POSTGRES_USER: vault_iam
      POSTGRES_PASSWORD: ${VAULT_IAM_DB_PASSWORD:?Set VAULT_IAM_DB_PASSWORD}
      VAULT_IAM_JWT_SECRET: ${VAULT_IAM_JWT_SECRET:?Set VAULT_IAM_JWT_SECRET}
      VAULT_IAM_MASTER_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${VAULT_IAM_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${VAULT_IAM_SECRET_ID:-}
      ENTRAID_SYNC_ENABLED: ${ENTRAID_SYNC_ENABLED:-false}
      ENTRAID_TENANT_ID: ${ENTRAID_TENANT_ID:-}
      ENTRAID_CLIENT_ID: ${ENTRAID_CLIENT_ID:-}
      ENTRAID_CLIENT_SECRET: ${ENTRAID_CLIENT_SECRET:-}
      ENTRAID_SYNC_INTERVAL: ${ENTRAID_SYNC_INTERVAL:-300}
    ports:
      - "8080:8080"
    networks:
      - neuro-network

  resolver:
    build:
      context: ../services/resolver
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-resolver
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      vault-iam:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: resolver
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${RESOLVER_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${RESOLVER_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
    networks:
      - neuro-network

  # ── Connectors ────────────────────────────────────────────

  connector-entraid:
    build:
      context: ../connectors/entraid
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-connector-entraid
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
    environment:
      NEURO_SERVICE_NAME: connector-entraid
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${ENTRAID_CONNECTOR_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${ENTRAID_CONNECTOR_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
    networks:
      - neuro-network

  connector-email:
    build:
      context: ../connectors/email
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-connector-email
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
    environment:
      NEURO_SERVICE_NAME: connector-email
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${EMAIL_CONNECTOR_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${EMAIL_CONNECTOR_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
    networks:
      - neuro-network

  connector-wazuh:
    build:
      context: ../connectors/wazuh
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-connector-wazuh
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
      vault-iam:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: connector-wazuh
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${WAZUH_CONNECTOR_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${WAZUH_CONNECTOR_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      WAZUH_VAULT_SECRET: wazuh
      WAZUH_ROUTING_PREFIX: wazuh
      WAZUH_INSTANCE_LABEL: desktops
    networks:
      - neuro-network

  connector-wazuh-infra:
    build:
      context: ../connectors/wazuh
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-connector-wazuh-infra
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
      vault-iam:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: connector-wazuh-infra
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${WAZUH_INFRA_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${WAZUH_INFRA_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      WAZUH_VAULT_SECRET: wazuh-infra
      WAZUH_ROUTING_PREFIX: wazuh-infra
      WAZUH_INSTANCE_LABEL: infrastructure
    networks:
      - neuro-network

  connector-slack:
    build:
      context: ../connectors/slack
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-connector-slack
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
      resolver:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: connector-slack
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${SLACK_CONNECTOR_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${SLACK_CONNECTOR_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
    networks:
      - neuro-network

  # ── Scheduler ─────────────────────────────────────────────

  scheduler:
    build:
      context: ../services/scheduler
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-scheduler
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
      vault-db:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: scheduler
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${SCHEDULER_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${SCHEDULER_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      KB_DB_HOST: vault-db
      KB_DB_USER: vault_iam
      KB_DB_PASSWORD: ${VAULT_IAM_DB_PASSWORD}
      KB_DB_NAME: neuro_vault
      KEVIN_MAILBOX: kevin@heads-up.com
    networks:
      - neuro-network

  # ── Audit ──────────────────────────────────────────────────

  vault-audit:
    build:
      context: ../services/vault-audit
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-vault-audit
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      vault-db:
        condition: service_started
    environment:
      NEURO_SERVICE_NAME: vault-audit
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${VAULT_AUDIT_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${VAULT_AUDIT_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      KB_DB_HOST: vault-db
      KB_DB_USER: vault_iam
      KB_DB_PASSWORD: ${VAULT_IAM_DB_PASSWORD}
      KB_DB_NAME: neuro_vault
      AUDIT_LOG_DIR: /var/log/neuronet/audit
    volumes:
      - audit-logs:/var/log/neuronet/audit
    networks:
      - neuro-network

  # ── Agents ────────────────────────────────────────────────

  agent-worker-claude:
    build:
      context: ../agents/worker-claude
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-agent-claude
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      hcvault:
        condition: service_healthy
    environment:
      NEURO_SERVICE_NAME: agent-worker-claude
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${CLAUDE_WORKER_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${CLAUDE_WORKER_SECRET_ID:-}
      VAULT_IAM_URL: http://vault-iam:8080
      VAULT_IAM_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      KB_DB_HOST: vault-db
      KB_DB_USER: vault_iam
      KB_DB_PASSWORD: ${VAULT_IAM_DB_PASSWORD}
      KB_DB_NAME: neuro_vault
    networks:
      - neuro-network

volumes:
  rabbitmq-data:
  hcvault-data:
  vault-db-data:
  audit-logs:

networks:
  neuro-network:
    name: neuro-network
