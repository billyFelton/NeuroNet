services:

  hcvault:
    image: hashicorp/vault:1.15
    container_name: neuro-hcvault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_ADDR: "http://0.0.0.0:8200"
      VAULT_API_ADDR: "http://hcvault:8200"
      VAULT_LOCAL_CONFIG: |
        {
          "storage": { "file": { "path": "/vault/data" } },
          "listener": { "tcp": { "address": "0.0.0.0:8200", "tls_disable": true } },
          "ui": true,
          "disable_mlock": false
        }
    command: server
    volumes:
      - hcvault-data:/vault/data
      - ./hcvault/policies:/vault/policies:ro
    networks:
      - vault-internal
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://127.0.0.1:8200"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  vault-db:
    image: postgres:16-alpine
    container_name: neuro-vault-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: neuro_vault
      POSTGRES_USER: neuro
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD}
    volumes:
      - vault-db-data:/var/lib/postgresql/data
      - ./db/001_schema.sql:/docker-entrypoint-initdb.d/001_schema.sql:ro
    networks:
      - vault-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U neuro -d neuro_vault"]
      interval: 10s
      timeout: 5s
      retries: 5

  vault-iam:
    build:
      context: ./vault-iam
      args:
        NEUROKIT_VERSION: ${NEUROKIT_VERSION:-v0.2.0}
    container_name: neuro-vault-iam
    restart: unless-stopped
    depends_on:
      vault-db:
        condition: service_healthy
      hcvault:
        condition: service_healthy
    environment:
      NEURO_SERVICE_NAME: vault-iam
      NEURO_SERVICE_VERSION: "0.1.0"
      NEURO_ENVIRONMENT: ${NEURO_ENVIRONMENT:-development}
      POSTGRES_HOST: vault-db
      POSTGRES_PORT: 5432
      POSTGRES_DB: neuro_vault
      POSTGRES_USER: vault_iam
      POSTGRES_PASSWORD: ${VAULT_IAM_DB_PASSWORD:?Set VAULT_IAM_DB_PASSWORD}
      HCVAULT_URL: http://hcvault:8200
      HCVAULT_ROLE_ID: ${VAULT_IAM_ROLE_ID:-}
      HCVAULT_SECRET_ID: ${VAULT_IAM_SECRET_ID:-}
      VAULT_IAM_JWT_SECRET: ${VAULT_IAM_JWT_SECRET:?Set VAULT_IAM_JWT_SECRET}
      VAULT_IAM_MASTER_SERVICE_TOKEN: ${VAULT_IAM_MASTER_SERVICE_TOKEN:-}
      ENTRAID_SYNC_ENABLED: ${ENTRAID_SYNC_ENABLED:-false}
      ENTRAID_TENANT_ID: ${ENTRAID_TENANT_ID:-}
      ENTRAID_CLIENT_ID: ${ENTRAID_CLIENT_ID:-}
      ENTRAID_CLIENT_SECRET: ${ENTRAID_CLIENT_SECRET:-}
      ENTRAID_SYNC_INTERVAL: ${ENTRAID_SYNC_INTERVAL:-300}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-neuro}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/neuro}
      CONDUCTOR_URL: ${CONDUCTOR_URL:-http://conductor:8080}
    networks:
      - vault-internal
      - neuro-network
    ports:
      - "${VAULT_IAM_PORT:-8080}:8080"

volumes:
  hcvault-data:
  vault-db-data:

networks:
  vault-internal:
    internal: true
  neuro-network:
    external: true
